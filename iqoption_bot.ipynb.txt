{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "!pip install --quiet yfinance pandas==2.2.2 matplotlib mplfinance\n",
    "!pip install --quiet git+https://github.com/Lu-Yi-Hsun/iqoptionapi.git\n",
    "print(\"ðŸ“¦ à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡à¹€à¸ªà¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "import yfinance as yf\n",
    "import pandas as pd\n",
    "from iqoptionapi.stable_api import IQ_Option\n",
    "import time\n",
    "from datetime import datetime\n",
    "\n",
    "# ===== à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸šà¸±à¸à¸Šà¸µ =====\n",
    "IQ_EMAIL = \"à¹ƒà¸ªà¹ˆà¸­à¸µà¹€à¸¡à¸¥à¸‚à¸­à¸‡à¸„à¸¸à¸“\"\n",
    "IQ_PASSWORD = \"à¹ƒà¸ªà¹ˆà¸žà¸²à¸ªà¹€à¸§à¸´à¸£à¹Œà¸”à¸‚à¸­à¸‡à¸„à¸¸à¸“\"\n",
    "STAKE = 300  # à¹€à¸‡à¸´à¸™à¸¥à¸‡à¸—à¸¸à¸™à¸•à¹ˆà¸­à¹„à¸¡à¹‰\n",
    "\n",
    "# ===== à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ IQ Option =====\n",
    "I_want_money = IQ_Option(IQ_EMAIL, IQ_PASSWORD)\n",
    "check, reason = I_want_money.connect()\n",
    "\n",
    "if check:\n",
    "    print(\"âœ… Login à¸ªà¸³à¹€à¸£à¹‡à¸ˆ\")\n",
    "else:\n",
    "    print(\"âŒ Login à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§:\", reason)\n",
    "    raise SystemExit"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# ===== à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸„à¸³à¸™à¸§à¸“ EMA + RSI =====\n",
    "def calculate_signals(df):\n",
    "    df[\"EMA\"] = df[\"Close\"].ewm(span=14, adjust=False).mean()\n",
    "\n",
    "    delta = df[\"Close\"].diff()\n",
    "    gain = delta.where(delta > 0, 0)\n",
    "    loss = -delta.where(delta < 0, 0)\n",
    "\n",
    "    avg_gain = gain.rolling(window=14, min_periods=1).mean()\n",
    "    avg_loss = loss.rolling(window=14, min_periods=1).mean()\n",
    "\n",
    "    rs = avg_gain / avg_loss\n",
    "    rs = rs.replace([float('inf'), -float('inf')], 0).fillna(0)\n",
    "\n",
    "    df[\"RSI\"] = 100 - (100 / (1 + rs))\n",
    "\n",
    "    df[\"Signal\"] = (df[\"Close\"] > df[\"EMA\"]) & (df[\"RSI\"] < 30)\n",
    "\n",
    "    return df"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# ===== à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸§à¸²à¸‡à¸­à¸­à¹€à¸”à¸­à¸£à¹Œ =====\n",
    "def place_trade_iq(asset, signal):\n",
    "    direction = \"call\" if signal else \"put\"\n",
    "    check, id = I_want_money.buy(STAKE, asset, direction, 1)\n",
    "    if check:\n",
    "        return f\"à¸ªà¹ˆà¸‡à¸„à¸³à¸ªà¸±à¹ˆà¸‡ {direction.upper()} à¸ªà¸³à¹€à¸£à¹‡à¸ˆ ID: {id}\"\n",
    "    else:\n",
    "        return \"à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§\""
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# ===== à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸„à¸¹à¹ˆà¹€à¸‡à¸´à¸™ =====\n",
    "pairs = [\"EURGBP=X\", \"GBPUSD=X\"]\n",
    "UPDATE_SEC = 60\n",
    "last_signal_time = {}\n",
    "\n",
    "# ===== Loop à¸«à¸¥à¸±à¸ =====\n",
    "while True:\n",
    "    for pair in pairs:\n",
    "        data = yf.download(pair, period=\"1d\", interval=\"1m\")\n",
    "        if data.empty:\n",
    "            continue\n",
    "\n",
    "        data = calculate_signals(data)\n",
    "        latest_sig = data[\"Signal\"].iat[-1]\n",
    "        latest_time = data.index[-1]\n",
    "\n",
    "        if latest_sig and last_signal_time.get(pair) != latest_time:\n",
    "            iq_asset = pair.replace(\"=X\", \"\")\n",
    "            print(f\"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] {pair} à¸ªà¸±à¸à¸à¸²à¸“: {latest_sig}\")\n",
    "            note = place_trade_iq(iq_asset, latest_sig)\n",
    "            print(note)\n",
    "            last_signal_time[pair] = latest_time\n",
    "\n",
    "        time.sleep(1)\n",
    "\n",
    "    time.sleep(UPDATE_SEC)"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "name": "python",
   "version": "3.10"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 2
}
